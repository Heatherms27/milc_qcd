#  Wilson fermions
#  MIMD version 4
#  Makefile for Cray T3e, PVM: CD 12/18/96
#

#Where the complex and su3 libraries are
LIBDIR = ../libraries

HEADERS= $(LIBDIR)/complex.h $(LIBDIR)/su3.h $(LIBDIR)/comdefs.h lattice_w_hl.h $(LIBDIR)/io_wprop.h

# include file defining site structure, etc., for compiling generic code */
LATDEF =  -DLATDEF='"../wilson_invert/lattice_w_hl.h"'
# The quotation marks are necessary, as is the "../wilson_invert", since
# some compilations will be done in another directory

# Choose one of the lattice layout algorithms:
LAYOUT = layout_hyper

OBJECTS=  w_source.o w_sink.o dslash_lean.o setup_w.o \
	$(LAYOUT).o io_lat3.o check_unitarity.o io_w.o io_wb.o \
        gauge_header.o wilson_header.o fast_wilson_save.o \
	gaugefix_w.o w_meson.o w_baryon.o w_baryon_hl.o io_ansi.o

MACHINE_DEP = com_t3e.o 

#Libraries for complex numbers and su3 functions
QCDLIB = $(LIBDIR)/su3.a $(LIBDIR)/complex.a 

CFLAGS= -O -DPROTO -DPVM3 -DT3E -DSHORT32 -I$(LIBDIR) $(LATDEF)
#CFLAGS= -g -DPROTO -DPVM3 -DT3E -DSHORT32 -I$(LIBDIR) $(LATDEF)

COMPILER = cc
 
.c.o:
	$(COMPILER) $(CFLAGS) -c  $(DEFINES) $*.c

$(OBJECTS) $(EXTRA_OBJECTS) : $(HEADERS)

# Note: we prefer double precison version of inverters (for global sums)
su3_whl_cg::
	make -f Make_t3e_hl target "MYTARGET= su3_whl_cg" \
	"DEFINES= -DRESTRICT_FFT" \
	"EXTRA_OBJECTS= control_w_hl.o restrict_fourier.o d_cgilu_lean.o"

su3_whl_bi::
	make -f Make_t3e_hl target "MYTARGET= su3_whl_bi" \
	"DEFINES= -DRESTRICT_FFT -DBI" \
	"EXTRA_OBJECTS= control_w_hl.o restrict_fourier.o d_bicgilu_lean.o"

su3_whl_bi_m::
	make -f Make_t3e_hl target "MYTARGET= su3_whl_bi_m" \
	"DEFINES= -DRESTRICT_FFT -DBI" \
	"EXTRA_OBJECTS= control_m_w_hl.o restrict_fourier.o d_bicgilu-m_lean.o d_bicgilu_lean.o"

clean:
	rm -f *.o

# Choose one of the lattice layout algorithms:
# Nope!! now we use the local version that has layout_flag
#$(LAYOUT).o: ../generic/$(LAYOUT).c $(HEADERS)
#TARGET=cray-t3e; export TARGET ;\
#$(COMPILER) $(CFLAGS) -c $(DEFINES) ../generic/$(LAYOUT).c
com_t3e.o: ../generic/com_t3e.c $(HEADERS)
	$(COMPILER) $(CFLAGS) -c $(DEFINES) ../generic/com_t3e.c
io_lat3.o: ../generic/io_lat3.c $(HEADERS)
	$(COMPILER) $(CFLAGS) -c $(DEFINES) ../generic/io_lat3.c
io_wb.o: ../generic/io_wb.c $(HEADERS)
	$(COMPILER) $(CFLAGS) -c $(DEFINES) ../generic/io_wb.c
io_ansi.o: ../generic/io_ansi.c $(HEADERS)
	$(COMPILER) $(CFLAGS) -c $(DEFINES) ../generic/io_ansi.c 
check_unitarity.o: ../generic/check_unitarity.c $(HEADERS)
	$(COMPILER) $(CFLAGS) -c $(DEFINES) ../generic/check_unitarity.c
restrict_fourier.o: ../generic/restrict_fourier.c $(HEADERS)
	$(COMPILER) $(CFLAGS) -c $(DEFINES) ../generic/restrict_fourier.c 

target: $(OBJECTS) $(MACHINE_DEP) $(EXTRA_OBJECTS) $(QCDLIB)
	cc -o $(MYTARGET) -D rdahead=on \
	$(OBJECTS) $(MACHINE_DEP) $(EXTRA_OBJECTS) -l $(QCDLIB) -lapp -lpvm3
