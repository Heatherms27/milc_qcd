# Makefile for testing code by comparing test output with sample output
# For heavy

# Tests only su3_static_mr and su3_sum (not su3_hev_cg)  CD 12/06/97

# Example: 
#    make -f Make_test "ARCH=vanilla" test

# For comparing test output with sample output

# Instructions...
# 1.  Select the appropriate job launch command below.
# 2.  There should already be sample output files constructed from
#     code that you trust.
# 3.  Run the command
#        make -f Make_test test

# Change to suit...

# SGI Origin
#LAUNCH = mpirun -np 4
#LAUNCH2 = 
#ARCH = origin_mpi

# T3E
#LAUNCH = mpprun -n 4
#LAUNCH2 = 
#ARCH = t3e_mpi

# Linux
#  MPICH
#LAUNCH = /uufs/icebox/sys/pkg/mpich/1.2.1/bin/mpirun -np 4 -machinefile $$PBS_NODEFILE
#  VMI
#LAUNCH = /usr/local/bin/vmi-launch -ncpus 8 --
#LAUNCH2 = 
#ARCH = linux_mpi

# Compaq Alpha cluster (tcsini)
#LAUNCH = prun -N $$RMS_NODES -n $$RMS_PROCS # (tcsini)
#LAUNCH = prun -p test -B 1 -N 1 -n 4 # (CHPC sierra cluster - private node sierra1)
#LAUNCH2 =
#ARCH = tcs_mpi

# SP
#LAUNCH = poe 
#LAUNCH2 = -nodes 1 -tasks_per_node 4 -rmpool 1 -euilib ip -euidevice en0
#ARCH = sp_mpi

# Scalar
LAUNCH =
LAUNCH2 = 
ARCH = vanilla

PATTERNS = Here END
TOL = 1e-5
OUTTEST = out.test.matrix
OUTSAMPLE = out.sample.matrix
BINTEST = bin.test.matrix
READMATRIX = read_matrix_code/look.x

${READMATRIX}: read_matrix_code/read_vary_matrix.c
	cd read_matrix_code; make look.x

${BINTEST}.su3_static_mr: su3_static_mr ${READMATRIX} in.sample.su3_static_mr
	${LAUNCH} su3_static_mr ${LAUNCH2} < in.sample.su3_static_mr > out.test.su3_static_mr

${BINTEST}.su3_static_cg: su3_static_cg ${READMATRIX} in.sample.su3_static_cg
	${LAUNCH} su3_static_cg ${LAUNCH2} < in.sample.su3_static_cg > out.test.su3_static_cg


${OUTTEST}.su3_static_mr: ${READMATRIX} ${BINTEST}.su3_static_mr ${BINTEST}.su3_static_mr
	${READMATRIX} ${BINTEST}.su3_static_mr > ${OUTTEST}.su3_static_mr
	/bin/rm ${BINTEST}.su3_static_mr

${OUTTEST}.su3_static_cg: ${READMATRIX} ${BINTEST}.su3_static_cg ${BINTEST}.su3_static_cg
	${READMATRIX} ${BINTEST}.su3_static_cg > ${OUTTEST}.su3_static_cg
	/bin/rm ${BINTEST}.su3_static_cg

out.test.diff.matrix.su3_static_mr:  ${OUTTEST}.su3_static_mr ${OUTSAMPLE}.su3_static_mr
	../headtail.pl ${PATTERNS} < ${OUTTEST}.su3_static_mr > out.test.matrix.tmp
	../headtail.pl ${PATTERNS} < ${OUTSAMPLE}.su3_static_mr > out.sample.matrix.tmp
	../diffn.pl out.test.matrix.tmp out.sample.matrix.tmp ${TOL} > \
	   out.test.diff.matrix.su3_static_mr
	rm out.test.matrix.tmp out.sample.matrix.tmp

out.test.diff.matrix.su3_static_cg:  ${OUTTEST}.su3_static_cg ${OUTSAMPLE}.su3_static_cg
	../headtail.pl ${PATTERNS} < ${OUTTEST}.su3_static_cg > out.test.matrix.tmp
	../headtail.pl ${PATTERNS} < ${OUTSAMPLE}.su3_static_cg > out.sample.matrix.tmp
	../diffn.pl out.test.matrix.tmp out.sample.matrix.tmp ${TOL} > \
	   out.test.diff.matrix.su3_static_cg
	rm out.test.matrix.tmp out.sample.matrix.tmp

test:
	cp -p ../Make_${ARCH} .
	make -f Make_${ARCH} su3_static_mr
	make -f Make_test out.test.diff.matrix.su3_static_mr
	make -f Make_${ARCH} su3_static_cg
	make -f Make_test out.test.diff.matrix.su3_static_cg

check: test

clean: test_clean
